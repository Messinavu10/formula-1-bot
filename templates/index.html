<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>F1Bot</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    :root {
      --black: #000;
      --white: #fff;
      --gray: #f5f5f5;
      --gray-dark: #222;
      --gray-border: #e0e0e0;
      --green: #27c93f;
      --red: #e10600;
      --yellow: #ffd700;
    }

    /* Dark mode variables */
    [data-theme="dark"] {
      --black: #fff;
      --white: #1a1a1a;
      --gray: #2a2a2a;
      --gray-dark: #e0e0e0;
      --gray-border: #444;
    }

    /* Theme toggle button */
    .theme-toggle {
      background: var(--gray);
      border: 1px solid var(--gray-border);
      border-radius: 20px;
      padding: 0.5rem 1rem;
      color: var(--black);
      font-size: 0.9rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 0.5rem;
      transition: all 0.2s ease;
      margin-right: 1rem;
    }

    .theme-toggle:hover {
      background: var(--gray-border);
    }

    .theme-toggle i {
      font-size: 1rem;
    }

    /* Update status positioning */
    .status {
      font-size: 1rem;
      color: var(--gray-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      padding-right: 1rem;
      white-space: nowrap;
    }

    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow-x: hidden;
    }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--white);
      color: var(--black);
    }

    .container {
      width: 100vw;
      height: 100vh;
      display: flex;
      flex-direction: column;
      overflow: hidden; /* Prevent scrollbars */
    }

    .header {
      background: var(--white);
      border-bottom: 1px solid var(--gray-border);
      padding: 1rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      box-sizing: border-box;
      overflow: visible;
      position: relative;
      flex-shrink: 0; /* Prevent header from shrinking */
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 1rem;
      font-size: 1.5rem;
      font-weight: 700;
      cursor: pointer; /* Add this line */
      transition: opacity 0.2s ease; /* Add this line */
    }

    .logo:hover {
      opacity: 0.8; /* Add this line */
    }

    .logo img {
      height: 120px;
      width: auto;
      display: block;
      object-fit: contain;
      max-width: 150px;
      position: absolute;
      top: -25px;
      left: 0;
      transition: filter 0.3s ease;
    }

    /* Make logo white in dark mode */
    [data-theme="dark"] .logo img {
      filter: invert(1) brightness(1); /* Inverts black to white */
    }

    .status {
      font-size: 1rem;
      color: var(--gray-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: 0; /* Remove margin */
      padding-right: 1rem; /* Add padding instead */
      white-space: nowrap;
    }

    .status-dot {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      display: inline-block;
      background: var(--red);
      border: 1px solid var(--gray-border);
      transition: background 0.2s;
    }

    .status-dot.ready { background: var(--green); }
    .status-dot.offline { background: var(--red); }
    .status-dot.init { background: var(--yellow); }

    .chat-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      margin: 1vw; /* Use viewport units */
      border-radius: 12px;
      border: 1px solid var(--gray-border);
      overflow: hidden;
      min-height: 0; /* Allow flex shrinking */
    }

    .chat-messages {
      flex: 1;
      padding: 2vw; /* Use viewport units */
      overflow-y: auto;
      background: var(--white);
      min-height: 0; /* Allow flex shrinking */
    }

    .welcome-message {
      text-align: center;
      margin-bottom: 0.5rem; /* Reduced from 1.5rem */
      background: var(--gray);
      border-radius: 20px;
      padding: 0.2rem 1rem; /* Reduced from 0.5rem 1rem */
      max-width: 400px;
      margin-left: auto;
      margin-right: auto;
    }

    .welcome-message h2 {
      font-size: 1.5rem; /* Reduced from 1.3rem */
      font-weight: 700;
      margin-bottom: 0.2rem; /* Reduced from 0.25rem */
      color: var(--black);
    }

    .welcome-message p {
      color: var(--gray-dark);
      margin-bottom: 0.2rem; /* Reduced from 0.5rem */
      font-size: 0.9rem; /* Reduced from 0.85rem */
    }

    .sample-queries {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 0.5rem; /* Reduced from 0.5rem */
      margin-top: 0.2rem; /* Reduced from 0.5rem */
    }

    .sample-queries code {
      background: var(--white);
      color: var(--black);
      border-radius: 6px;
      border: 1px solid var(--gray-border);
      padding: 0.3rem; /* Reduced from 0.4rem */
      font-size: 0.75rem; /* Reduced from 0.8rem */
      text-align: center;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      cursor: pointer;
      transition: all 0.2s ease;
      user-select: none;
    }

    .sample-queries code:hover {
      background: var(--gray);
      border-color: var(--black);
      transform: translateY(-1px); /* Slight lift effect */
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }

    .sample-queries code:active {
      transform: translateY(0); /* Press down effect */
    }

    /* Fix for status text being cut off */
    .status {
      font-size: 1rem;
      color: var(--gray-dark);
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-right: 1rem; /* Add margin to prevent cutoff */
      white-space: nowrap; /* Prevent text wrapping */
    }

    /* Input area styles - these were missing! */
    .input-container {
      padding: 1.5vw 2vw; /* Use viewport units */
      background: var(--white);
      border-top: 1px solid var(--gray-border);
      width: 100%;
      box-sizing: border-box;
      position: relative;
      flex-shrink: 0; /* Prevent input from shrinking */
    }

    .input-wrapper {
      display: flex;
      gap: 1vw; /* Use viewport units */
      align-items: flex-end;
      width: 100%;
      max-width: 100%;
    }

    .chat-input {
      flex: 1;
      background: var(--gray);
      border: 1px solid var(--gray-border);
      border-radius: 20px;
      padding: 1rem 1.5rem;
      color: var(--black);
      font-size: clamp(0.9rem, 2vw, 1.2rem); /* Responsive font size */
      font-family: inherit;
      resize: none;
      outline: none;
      min-height: 50px;
      max-height: 120px;
      width: 100%;
      box-sizing: border-box;
    }

    .chat-input:focus {
      border-color: var(--black);
      box-shadow: 0 0 0 2px rgba(0,0,0,0.1);
    }

    .chat-input::placeholder {
      color: var(--gray-dark);
      opacity: 0.7;
    }

    .send-button {
      background: var(--black);
      border: none;
      border-radius: 50%;
      width: clamp(40px, 5vw, 60px); /* Responsive button size */
      height: clamp(40px, 5vw, 60px);
      color: var(--white);
      font-size: clamp(1rem, 2.5vw, 1.5rem); /* Responsive icon size */
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
      flex-shrink: 0;
      box-sizing: border-box;
    }

    .send-button:hover {
      background: var(--gray-dark);
      transform: scale(1.05);
    }

    .send-button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none;
    }

    /* Typing indicator styles */
    .typing-indicator {
      display: none;
      padding: 1rem 1.5rem;
      background: var(--gray);
      border-radius: 20px;
      border-bottom-left-radius: 8px;
      border: 1px solid var(--gray-border);
      max-width: 80%;
      margin-bottom: 1.5rem;
    }

    .typing-dots {
      display: flex;
      gap: 4px;
    }

    .typing-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--black);
      animation: typing 1.4s infinite ease-in-out;
    }

    .typing-dot:nth-child(1) { animation-delay: -0.32s; }
    .typing-dot:nth-child(2) { animation-delay: -0.16s; }

    @keyframes typing {
      0%, 80%, 100% {
        transform: scale(0.8);
        opacity: 0.5;
      }
      40% {
        transform: scale(1);
        opacity: 1;
      }
    }

    /* Message styles */
    .message {
      margin-bottom: 1.5rem;
    }

    .message.user {
      text-align: right;
    }

    .message.bot {
      text-align: left;
    }

    .message-content {
      display: inline-block;
      max-width: 80vw; /* Use viewport units */
      padding: 1rem 1.5rem;
      border-radius: 20px;
      font-size: clamp(0.8rem, 2vw, 1rem); /* Responsive font size */
      line-height: 1.5;
      word-wrap: break-word;
      white-space: pre-wrap;
    }

    .message.user .message-content {
      background: var(--black);
      color: var(--white);
      border-bottom-right-radius: 8px;
    }

    .message.bot .message-content {
      background: var(--gray);
      color: var(--black);
      border-bottom-left-radius: 8px;
      border: 1px solid var(--gray-border);
    }

    /* Visualization styles */
    .visualization-container {
      margin-top: 1rem;
      background: var(--white);
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid var(--gray-border);
    }

    .visualization-header {
      background: var(--gray);
      padding: 0.75rem 1rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      border-bottom: 1px solid var(--gray-border);
    }

    .visualization-title {
      font-weight: 600;
      color: var(--black);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .visualization-actions {
      display: flex;
      gap: 0.5rem;
    }

    .viz-action-btn {
      background: var(--black);
      border: none;
      border-radius: 6px;
      padding: 0.25rem 0.5rem;
      color: var(--white);
      font-size: 0.8rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .viz-action-btn:hover {
      background: var(--gray-dark);
    }

    .visualization-frame {
      width: 100%;
      height: 500px;
      border: none;
      background: var(--white);
    }

    /* Responsive breakpoints */
    @media (max-width: 768px) {
      .chat-container {
        margin: 0.5vw;
      }
      
      .input-container {
        padding: 1vw;
      }
      
      .sample-queries {
        grid-template-columns: 1fr; /* Single column on mobile */
      }
      
      .visualization-frame {
        height: 300px;
      }
    }

    @media (max-width: 480px) {
      .header {
        padding: 0.05rem 1vw;
      }
      
      .logo img {
        height: 80px; /* Smaller logo on very small screens */
        max-width: 100px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <header class="header">
      <div class="logo">
        <img src="/assets/logo.png" alt="F1Bot Logo">
      </div>
      <div style="display: flex; align-items: center; gap: 1rem;">
        <button class="theme-toggle" id="theme-toggle">
          <i class="fas fa-moon" id="theme-icon"></i>
          <span id="theme-text">Dark</span>
        </button>
        <div class="status">
          <span class="status-dot ready" id="status-dot"></span>
          <span id="status-text">Ready</span>
        </div>
      </div>
    </header>

    <div class="chat-container">
      <div class="chat-messages" id="chat-messages">
        <div class="message bot">
          <div class="message-content">
            <div class="welcome-message">
              <h2>Welcome to F1Bot!</h2>
              <p>Your AI-powered Formula 1 data assistant.<br>Try these sample queries to get started:</p>
              <div class="sample-queries">
                <code>Who won the Monaco Grand Prix?</code>
                <code>Show me the pit stop analysis for Bahrain</code>
                <code>Compare Max and Lewis at the Monaco GP</code>
                <code>Visualize the lap time progression for Australian GP</code>
                <code>What was the fastest lap in Miami?</code>
                <code>Show tire strategy for Ferrari at the Chinese GP</code>
                <code>What happened on lap 67 of the Canadian GP?</code>
                <code>Position changes for Lando Norris in Silverstone</code>
                <code>Create a sector chart for Charles vs Lando at the Japanese GP</code>
                <code>Visualize pit stops between the Red Bull drivers at the Austrian GP</code>
              </div>
            </div>
          </div>
        </div>

            </div>
            <!-- Typing Indicator -->
            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dots">
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                    <div class="typing-dot"></div>
                </div>
            </div>

            <!-- Input Area -->
            <div class="input-container">
                <div class="input-wrapper">
                    <textarea 
                        id="chat-input" 
                        class="chat-input" 
                        placeholder="Ask about F1 racing or request visualizations..."
                        rows="1"
                    ></textarea>
                    <button id="send-button" class="send-button">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        class F1Chatbot {
            constructor() {
                this.chatMessages = document.getElementById('chat-messages');
                this.chatInput = document.getElementById('chat-input');
                this.sendButton = document.getElementById('send-button');
                this.typingIndicator = document.getElementById('typing-indicator');
                this.statusText = document.getElementById('status-text');
                this.statusDot = document.getElementById('status-dot');
                this.themeToggle = document.getElementById('theme-toggle');
                this.themeIcon = document.getElementById('theme-icon');
                this.themeText = document.getElementById('theme-text');
                this.isProcessing = false;
                
                // Initialize the chatbot
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.autoResizeTextarea();
                this.checkHealth();
                this.initTheme();
            }

            initTheme() {
                // Load saved theme or default to light
                const savedTheme = localStorage.getItem('f1bot-theme') || 'light';
                this.setTheme(savedTheme);
            }

            setupEventListeners() {
                this.sendButton.addEventListener('click', () => this.sendMessage());
                this.chatInput.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                this.chatInput.addEventListener('input', () => {
                    this.autoResizeTextarea();
                });

                // Theme toggle
                this.themeToggle.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme');
                    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                    this.setTheme(newTheme);
                });

                // Add click listener for logo refresh
                const logo = document.querySelector('.logo');
                logo.addEventListener('click', () => {
                    window.location.reload();
                });

                // Add click listeners for sample queries
                this.setupSampleQueryListeners();
            }

            setupSampleQueryListeners() {
                const sampleQueries = [
                    'Who won the Monaco Grand Prix?',
                    'Show me the pit stop analysis for Bahrain',
                    'Compare Max and Lewis at the Monaco GP',
                    'Visualize the lap time progression for Australian GP',
                    'What was the fastest lap in Miami?',
                    'Show tire strategy for Ferrari at the Chinese GP',
                    'What happened on lap 67 of the Canadian GP?',
                    'Position changes for Lando Norris in Silverstone',
                    'Create a sector chart for Charles vs Lando at the Japanese GP',
                    'Visualize pit stops between the Red Bull drivers at the Austrian GP'
                ];

                const queryElements = document.querySelectorAll('.sample-queries code');
                queryElements.forEach((element, index) => {
                    element.addEventListener('click', () => {
                        console.log('Sample query clicked:', sampleQueries[index]);
                        this.sendSampleQuery(sampleQueries[index]);
                    });
                });
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('f1bot-theme', theme); // This saves the theme
                
                // Update toggle button
                if (theme === 'dark') {
                    this.themeIcon.className = 'fas fa-sun';
                    this.themeText.textContent = 'Light';
                } else {
                    this.themeIcon.className = 'fas fa-moon';
                    this.themeText.textContent = 'Dark';
                }
            }

            async checkHealth() {
                try {
                    const response = await fetch('/api/health');
                    const data = await response.json();
                    const dot = this.statusDot;
                    if (data.status === 'healthy' && data.mcp_ready) {
                        this.statusText.textContent = 'Ready';
                        dot.classList.remove('offline', 'init');
                        dot.classList.add('ready');
                    } else {
                        this.statusText.textContent = 'Initializing...';
                        dot.classList.remove('ready', 'offline');
                        dot.classList.add('init');
                    }
                } catch (error) {
                    this.statusText.textContent = 'Offline';
                    this.statusDot.classList.remove('ready', 'init');
                    this.statusDot.classList.add('offline');
                }
            }

            sendSampleQuery(query) {
                console.log('sendSampleQuery called with:', query); // Debug log
                
                // Don't check for processing state for sample queries
                if (!query) return;

                console.log('Adding user message...'); // Debug log
                // Add user message
                this.addMessage(query, 'user');
                this.chatInput.value = '';

                console.log('Showing typing indicator...'); // Debug log
                // Show typing indicator
                this.showTypingIndicator();

                console.log('Sending request...'); // Debug log
                // Send the request
                this.sendRequest(query);
            }

            async sendRequest(message) {
                console.log('sendRequest called with:', message); // Debug log
                try {
                    const response = await fetch('/api/chat', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ message: message })
                    });

                    const data = await response.json();
                    console.log('Response received:', data); // Debug log

                    if (data.error) {
                        this.addMessage(`❌ ${data.error}`, 'bot');
                    } else {
                        this.addMessage(data.response, 'bot');
                        
                        // Handle visualization if present
                        if (data.visualization) {
                            this.displayVisualization(data.visualization);
                        }
                    }
                } catch (error) {
                    console.error('Error in sendRequest:', error); // Debug log
                    this.addMessage('❌ Sorry, I encountered an error. Please try again.', 'bot');
                } finally {
                    this.hideTypingIndicator();
                }
            }

            async sendMessage() {
                const message = this.chatInput.value.trim();
                if (!message || this.isProcessing) return;

                this.isProcessing = true;
                this.sendButton.disabled = true;
                this.chatInput.disabled = true;

                // Add user message
                this.addMessage(message, 'user');
                this.chatInput.value = '';

                // Show typing indicator
                this.showTypingIndicator();

                // Send the request
                await this.sendRequest(message);

                this.isProcessing = false;
                this.sendButton.disabled = false;
                this.chatInput.disabled = false;
                this.chatInput.focus();
            }

            displayVisualization(vizData) {
                const vizContainer = document.createElement('div');
                vizContainer.className = 'visualization-container';
                
                vizContainer.innerHTML = `
                    <div class="visualization-header">
                        <div class="visualization-title">
                            <i class="fas fa-chart-line"></i>
                            <span>F1 Data Visualization</span>
                        </div>
                        <div class="visualization-actions">
                            <button class="viz-action-btn" onclick="this.parentElement.parentElement.parentElement.remove()">
                                <i class="fas fa-times"></i> Close
                            </button>
                        </div>
                    </div>
                    <iframe 
                        src="/api/visualization/${vizData.filename}" 
                        class="visualization-frame"
                        title="F1 Data Visualization">
                    </iframe>
                `;
                
                this.chatMessages.appendChild(vizContainer);
                this.scrollToBottom();
            }

            addMessage(content, sender) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                
                if (sender === 'bot') {
                    // Convert markdown-style formatting to HTML
                    let formattedContent = content
                        .replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>')  // **bold** to <strong>
                        .replace(/\*(.*?)\*/g, '<em>$1</em>')              // *italic* to <em>
                        .replace(/`(.*?)`/g, '<code>$1</code>')            // `code` to <code>
                        .replace(/\n/g, '<br>');                           // \n to <br>
                    
                    contentDiv.innerHTML = formattedContent;
                } else {
                    // Use textContent for user messages (security)
                    contentDiv.textContent = content;
                }
                
                messageDiv.appendChild(contentDiv);
                this.chatMessages.appendChild(messageDiv);
                
                this.scrollToBottom();
            }

            showTypingIndicator() {
                this.typingIndicator.style.display = 'block';
                this.scrollToBottom();
            }

            hideTypingIndicator() {
                this.typingIndicator.style.display = 'none';
            }

            scrollToBottom() {
                setTimeout(() => {
                    this.chatMessages.scrollTop = this.chatMessages.scrollHeight;
                }, 100);
            }
        }

        // Initialize the chatbot when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            window.f1bot = new F1Chatbot();
        });
    </script>
</body>
</html>